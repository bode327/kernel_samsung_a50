# SPECTRUM KERNEL MANAGER
# Ramdisk file for profile based kernel management
# Implimentation inspired by Franco's fku profiles

#
## Initialization
#
on property:sys.boot_completed=1
    
    #Set Permission chown
    chown system system /sys/block/sda/queue/read_ahead_kb
    chown system system /sys/block/sda/queue/scheduler
    chown system system /sys/block/mmcblk0/queue/read_ahead_kb
    chown system system /sys/block/mmcblk0/queue/scheduler
    chown system system /sys/devices/platform/11500000.mali/power_policy
    chown system system /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
    chown system system /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq
    chown system system /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq
    chown system system /sys/devices/system/cpu/cpufreq/policy4/scaling_governor
    chown system system /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq
    chown system system /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/schedutil/down_rate_limit_us
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/schedutil/up_rate_limit_us
    chown system system /sys/module/sync/parameters/fsync_enabled
    chown system system /sys/kernel/dyn_fsync/Dyn_fsync_active
    chown system system /sys/module/mmc_core/parameters/use_spi_crc
    chown system system /proc/sys/net/ipv4/tcp_congestion_control
    chown system system /sys/kernel/fp_boost/enable
    chown system system /sys/module/workqueue/parameters/power_efficient
    
    #Set Permission chmod
    chmod 0644 /sys/block/sda/queue/read_ahead_kb
    chmod 0644 /sys/block/sda/queue/scheduler
    chmod 0644 /sys/block/mmcblk0/queue/read_ahead_kb
    chmod 0644 /sys/block/mmcblk0/queue/scheduler
    chmod 0644 /sys/devices/platform/11500000.mali/power_policy
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy4/scaling_governor
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq
    chmod 0644 /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq
    chmod 0644 /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us
    chmod 0644 /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/schedutil/down_rate_limit_us
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/schedutil/up_rate_limit_us
    chmod 0644 /sys/module/sync/parameters/fsync_enabled
    chmod 0644 /sys/kernel/dyn_fsync/Dyn_fsync_active
    chmod 0644 /sys/module/mmc_core/parameters/use_spi_crc
    chmod 0644 /proc/sys/net/ipv4/tcp_congestion_control
    chmod 0644 /sys/kernel/fp_boost/enable
    chmod 0644 /sys/module/workqueue/parameters/power_efficient
    
    # Set default profile on first boot
    exec u:r:init:s0 root root -- /init.spectrum.sh
    exec u:r:su:s0 root root -- /init.spectrum.sh
    exec u:r:magisk:s0 root root -- /init.spectrum.sh

    # Enable Spectrum support
    setprop spectrum.support 1

    # Add kernel name
    setprop persist.spectrum.kernel Optimized

#
## Profiles
#

# Balance (default profile)
on property:persist.spectrum.profile=0
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq 403000
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq 1742000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq 936000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq 2314000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us 200
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us 1000
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/down_rate_limit_us 200
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/up_rate_limit_us 2000

    write /sys/kernel/gpu/gpu_max_clock 1053000
    write /sys/kernel/gpu/gpu_min_clock 260000
    write /sys/block/sda/queue/read_ahead_kb 2048
    write /sys/block/sda/queue/scheduler "zen"
    write /sys/kernel/gpu/gpu_governor "Interactive"
    write /sys/devices/platform/11500000.mali/power_policy coarse_demand

    write /sys/module/sync/parameters/fsync_enabled Y
    write /sys/kernel/dyn_fsync/Dyn_fsync_active 1
    write /sys/module/mmc_core/parameters/use_spi_crc Y
    write /sys/module/workqueue/parameters/power_efficient Y
    write /sys/kernel/fp_boost/enable 0
    write /proc/sys/net/ipv4/tcp_congestion_control cubic

# Performance
on property:persist.spectrum.profile=1
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq 403000
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq 1742000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq 936000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq 2314000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us 1000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us 200
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/down_rate_limit_us 1000
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/up_rate_limit_us 200

    write /sys/kernel/gpu/gpu_max_clock 1053000
    write /sys/kernel/gpu/gpu_min_clock 260000
    write /sys/block/sda/queue/read_ahead_kb 4096
    write /sys/block/sda/queue/scheduler "fiops"
    write /sys/kernel/gpu/gpu_governor "Interactive"
    write /sys/devices/platform/11500000.mali/power_policy always_on

    write /sys/module/sync/parameters/fsync_enabled N
    write /sys/kernel/dyn_fsync/Dyn_fsync_active 0
    write /sys/module/mmc_core/parameters/use_spi_crc N
    write /sys/module/workqueue/parameters/power_efficient N
    write /proc/sys/net/ipv4/tcp_congestion_control westwood

# Battery
on property:persist.spectrum.profile=2
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq 403000
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq 1742000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq 936000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq 2314000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us 200
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us 10000
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/down_rate_limit_us 200
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutil/up_rate_limit_us 10000

    write /sys/kernel/gpu/gpu_max_clock 1053000
    write /sys/kernel/gpu/gpu_min_clock 260000
    write /sys/block/sda/queue/read_ahead_kb 1024
    write /sys/block/sda/queue/scheduler "noop"
    write /sys/kernel/gpu/gpu_governor "Interactive"
    write /sys/kernel/fp_boost/enable 0
    write /sys/devices/platform/11500000.mali/power_policy coarse_demand

    write /sys/module/sync/parameters/fsync_enabled Y
    write /sys/kernel/dyn_fsync/Dyn_fsync_active 1
    write /sys/module/mmc_core/parameters/use_spi_crc N
    write /sys/module/workqueue/parameters/power_efficient Y
    write /proc/sys/net/ipv4/tcp_congestion_control cubic

# Gaming
on property:persist.spectrum.profile=3
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_min_freq 403000
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_max_freq 1742000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_min_freq 936000
    write /sys/devices/system/cpu/cpufreq/policy4/scaling_max_freq 2314000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutilX/down_rate_limit_us 10000
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutilX/up_rate_limit_us 200
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutilX/down_rate_limit_us 10000
    write /sys/devices/system/cpu/cpu4/cpufreq/schedutilX/up_rate_limit_us 200

    write /sys/kernel/gpu/gpu_max_clock 1053000
    write /sys/kernel/gpu/gpu_min_clock 1053000
    write /sys/block/sda/queue/read_ahead_kb 4096
    write /sys/block/sda/queue/scheduler "deadline"
    write /sys/kernel/gpu/gpu_governor "Interactive"
    write /sys/devices/platform/11500000.mali/power_policy always_on

    write /sys/module/sync/parameters/fsync_enabled N
    write /sys/kernel/dyn_fsync/Dyn_fsync_active 0
    write /sys/module/mmc_core/parameters/use_spi_crc N
    write /sys/module/workqueue/parameters/power_efficient N
    write /proc/sys/net/ipv4/tcp_congestion_control westwood
